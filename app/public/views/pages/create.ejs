<script type="text/javascript" src="../../scripts/create.js"></script>
 
<div class="page">
    <h2>Guess That Song</h2>
    <!-- <form id="settings" action="POST"> -->
        <div id="settings-container" class="container">
            <h2 style="color: black; text-align: center;">Game Settings</h2>
            <div class="answer-container">
                <button class="answer-choice">Setting 1</button>
                <button class="answer-choice">Setting 2</button>
                <button class="answer-choice">Setting 3</button>
                <button class="answer-choice">Setting 4</button>
                <button class="answer-choice">Setting 5</button>
            </div>
        </div>
    <!-- </form> -->
    <button id="finish" class="next">Finish</button>
</div>
 
<div class="popup">
    <p>Are you sure?</p>
    <div class="button-container">
        <button id="back">No, keep editing</button>
        <button id="confirm">Yes, create quiz</button>
    </div>
</div>


<!-- Code to implemebt the audio (we need to move this later) -->
<button id="load">Load Songs</button>
<div id="songs"></div>
<audio id="player" controls></audio>

<script>
  const container = document.getElementById("songs");
  const player = document.getElementById("player");
  const loader = document.getElementById("load");

  let currentSnippets = [];
  let currentIndex = -1;
  let songButtons = [];
  let songNamesFromServer = [];


  fetch('/api/songNames')
    .then(r => r.json())
    .then(data => {
    
      songNamesFromServer = data.map(x => 
        typeof x === 'string' ? x
        : (x.query || `${x.name} ${x.artist || ''}`.trim())
      );
      console.log('Song Names From Server (strings):', songNamesFromServer);
    });

  async function fetchSnippets(names) {
    const res = await fetch("/deezer-snippets", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ songs: names }),
    });
    return res.json();
  }

  function resetPlayer() {
    player.pause();
    player.removeAttribute('src'); 
    player.load();
    currentIndex = -1;
  }

  
  function findNextWithPreview(fromIdx) {
    for (let j = fromIdx; j < currentSnippets.length; j++) {
      const p = currentSnippets[j]?.preview;
      if (p && typeof p === 'string' && p.trim().length > 0) return j;
    }
    return -1;
  }

  function playAtIndex(i) {
    if (i < 0 || i >= currentSnippets.length) return;

    if (!currentSnippets[i] || !currentSnippets[i].preview) {
      const nxt = findNextWithPreview(i + 1);
      if (nxt !== -1) {
        playAtIndex(nxt);
      }
      return;
    }

    const s = currentSnippets[i];
    currentIndex = i;
    player.src = s.preview;

    console.log("current index:", currentIndex, i);
    songButtons.forEach((btn) => {
        console.log("debug index:", btn.__origIndex, currentIndex);
        if (btn.__origIndex === i) {
            btn.textContent = `Now Playing: ${s.title} - ${s.artist}`;
        } else {
            btn.textContent = `Play: ${s.title} - ${s.artist}`; // or reset text
        }
    });

    // btn.textContent = `Now Playing: ${s.title} - ${s.artist}`
    console.log("playing object:", s.title);
    console.log("playing artist:",s.artist);
    console.log("player.src now:", player.src);
    player.play();
  }

  player.onended = () => {
    const next = findNextWithPreview(currentIndex + 1);
    if (next !== -1) {
      playAtIndex(next);
    } else {
      player.removeAttribute('src');
      player.load();
      currentIndex = -1;
    }
  };

  loader.addEventListener("click", async () => {
    container.innerHTML = "";
    songButtons = [];
    resetPlayer();

    const snippets = await fetchSnippets(songNamesFromServer);
    currentSnippets = snippets;

    console.table(currentSnippets.map((s, i) => ({
      i,
      title: s.title,
      artist: s.artist,
      previewTail: s?.preview ? s.preview.slice(-25) : null
    })));

    currentSnippets.forEach((s, i) => {
      if (!s?.found || !s?.preview) return;
      const div = document.createElement("div");
      const btn = document.createElement("button");
      btn.textContent = `Play: ${s.title} – ${s.artist}`;
      btn.__origIndex = i;
      btn.addEventListener("click", () => playAtIndex(i));
      songButtons.push(btn);
      div.appendChild(btn);
      container.appendChild(div);
    });

    console.log('buttons map:',
        songButtons.map((b, k) => ({k, type: typeof b.__origIndex, __origIndex: b.__origIndex,label: b.textContent.slice(0,40)})));
                              
    const firstPlayable = findNextWithPreview(0);
    if (firstPlayable !== -1 && songButtons.length) {
      const b = songButtons.find(b => b.__origIndex === firstPlayable) || songButtons[0];
      b.textContent = `Play: ${currentSnippets[firstPlayable].title} – ${currentSnippets[firstPlayable].artist} (click to play)`;
    }
  });
</script>
